<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GR8Date â€¢ Messages</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #fff;
      --border: #eaeef5;
      --text: #0f172a;
      --muted: #64748b;
      --brand: #ff5478;
      --brand-900: #e23c61;
      --shadow: 0 8px 28px rgba(15, 23, 42, 0.08);
      --radius: 16px;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.5 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    a {
      color: inherit;
      text-decoration: none;
    }

    /* Header */
    .site-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: #fff;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 0 rgba(15, 23, 42, 0.02);
    }
    .nav {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      min-height: 56px;
    }
    .brand {
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 22px;
      margin-right: auto;
    }
    .brand .date {
      color: var(--brand);
    }
    .top-icons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .icon-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    .icon-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
    }
    .icon-btn .material-icons {
      font-size: 22px;
    }
    .rot-90 {
      transform: rotate(90deg);
      display: inline-block;
    }

    /* Mobile Header */
    @media (max-width: 768px) {
      .nav {
        flex-direction: column;
        padding: 10px 16px 5px 16px;
      }
      .brand {
        margin: 0 auto;
        text-align: center;
        order: 1;
      }
      .top-icons {
        order: 2;
        justify-content: center;
        width: 100%;
        margin-top: 10px;
      }
      .icon-btn {
        width: 36px;
        height: 36px;
      }
      .icon-btn .material-icons {
        font-size: 20px;
      }
    }

    /* Main Content */
    .spacer {
      height: 56px;
    }
    @media (max-width: 768px) {
      .spacer {
        height: 100px;
      }
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }
    .conversation-item {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
      display: block;
      position: relative;
    }
    .conversation-item:hover {
      background: var(--bg);
      transform: translateX(4px);
    }
    .conversation-item:last-child {
      border-bottom: none;
    }
    .conversation-name {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .conversation-preview {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.4;
    }
    .conversation-time {
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }
    .no-messages {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    /* Badge */
    .badge {
      position: absolute;
      top: 4px;
      right: 6px;
      min-width: 16px;
      height: 16px;
      background: var(--brand);
      color: white;
      font-size: 10px;
      font-weight: 700;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Unread conversation styles */
    .unread-conversation {
      background: #f0f7ff;
      border-left: 4px solid #3b82f6;
    }

    .unread-text {
      font-weight: 600;
      color: var(--text);
    }

    .unread-badge {
      background: #ef4444;
      color: white;
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Access Request Styles */
    .access-request-item {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      margin-bottom: 10px;
    }
    .access-request-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 8px;
      text-decoration: none;
      display: inline-block;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }

    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Empty state enhancements */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    .empty-state .material-icons {
      font-size: 48px;
      color: var(--muted);
      margin-bottom: 16px;
    }
    .empty-state h3 {
      margin: 0 0 8px 0;
      color: var(--text);
    }
    .empty-state p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Fixed Header -->
  <header class="site-header">
    <div class="nav">
      <div class="brand"><span>GR8</span><span class="date">DATE</span></div>
      <div class="top-icons" aria-label="Header actions">
        <a class="icon-btn" href="{% url 'dashboard' %}" title="Dashboard">
          <span class="material-icons rot-90">u_turn_left</span>
        </a>
        <a class="icon-btn" href="#" data-open-search title="Search"><span class="material-icons">search</span></a>
        <a class="icon-btn" href="{% url 'messages_list' %}" title="Messages">
          <span class="material-icons">mail</span>
          <span class="badge" id="msg-badge" style="display: none;"></span>
        </a>
        <a class="icon-btn" href="{% url 'matches_list' %}" title="Matches"><span class="material-icons">groups</span></a>
        <a class="icon-btn" href="#" title="Hot Dates"><span class="material-icons">local_fire_department</span></a>
        <a class="icon-btn" href="{% url 'profile_edit' %}" title="My Profile"><span class="material-icons">person</span></a>
        <a class="icon-btn" href="{% url 'logout' %}" title="Logout"><span class="material-icons">logout</span></a>
      </div>
    </div>
  </header>

  <div class="spacer"></div>

  <div class="container">
    <h1 style="margin-bottom: 20px;">Messages</h1>
    
    <!-- Pending Access Requests -->
    {% if pending_requests_received %}
    <div class="card">
      <div style="padding: 16px; border-bottom: 1px solid var(--border);">
        <h3 style="margin: 0 0 10px 0;">Pending Photo Access Requests</h3>
        <p style="margin: 0; color: var(--muted); font-size: 14px;">Approve or deny private photo access requests</p>
      </div>
      {% for request in pending_requests_received %}
      <div class="conversation-item access-request-item">
        <div class="conversation-name">{{ request.requester.username }} wants to see your private photos</div>
        <div class="conversation-preview">Requested {{ request.created_at|timesince }} ago</div>
        <div class="access-request-actions">
          <a href="{% url 'approve_private_access' request.id %}" class="btn-sm btn-success">Approve</a>
          <a href="{% url 'deny_private_access' request.id %}" class="btn-sm btn-danger">Deny</a>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
    
    <!-- Conversations List -->
    <div class="card" id="conversations-list">
      {% if threads %}
        {% for thread in threads %}
          {% if thread.user_a == request.user %}
            {% with other_user=thread.user_b %}
            {% with last_message=thread.messages.last %}
            <!-- FIXED: Use pre-calculated unread_count from view instead of filter -->
            {% with unread_count=thread.unread_count %}
            <a href="{% url 'message_thread' other_user.id %}" class="conversation-item {% if unread_count > 0 %}unread-conversation{% endif %}">
              <div class="conversation-name">
                {{ other_user.username }}
                {% if unread_count > 0 %}
                <span class="unread-badge">{{ unread_count }}</span>
                {% endif %}
              </div>
              <div class="conversation-preview {% if unread_count > 0 %}unread-text{% endif %}">
                {% if last_message %}
                  {% if last_message.sender == request.user %}
                    <strong>You:</strong> 
                  {% endif %}
                  {{ last_message.text|truncatechars:60 }}
                {% else %}
                  No messages yet
                {% endif %}
              </div>
              <div class="conversation-time">
                {% if last_message %}
                  {{ last_message.created_at|timesince }} ago
                {% else %}
                  Start conversation
                {% endif %}
              </div>
            </a>
            {% endwith %}
            {% endwith %}
            {% endwith %}
          {% else %}
            {% with other_user=thread.user_a %}
            {% with last_message=thread.messages.last %}
            <!-- FIXED: Use pre-calculated unread_count from view instead of filter -->
            {% with unread_count=thread.unread_count %}
            <a href="{% url 'message_thread' other_user.id %}" class="conversation-item {% if unread_count > 0 %}unread-conversation{% endif %}">
              <div class="conversation-name">
                {{ other_user.username }}
                {% if unread_count > 0 %}
                <span class="unread-badge">{{ unread_count }}</span>
                {% endif %}
              </div>
              <div class="conversation-preview {% if unread_count > 0 %}unread-text{% endif %}">
                {% if last_message %}
                  {% if last_message.sender == request.user %}
                    <strong>You:</strong> 
                  {% endif %}
                  {{ last_message.text|truncatechars:60 }}
                {% else %}
                  No messages yet
                {% endif %}
              </div>
              <div class="conversation-time">
                {% if last_message %}
                  {{ last_message.created_at|timesince }} ago
                {% else %}
                  Start conversation
                {% endif %}
              </div>
            </a>
            {% endwith %}
            {% endwith %}
            {% endwith %}
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <span class="material-icons">chat</span>
          <h3>No messages yet</h3>
          <p>Start conversations by messaging other users from their profiles!</p>
          <div style="margin-top: 20px;">
            <a href="{% url 'dashboard' %}" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--brand); color: white; border-radius: 12px; text-decoration: none; font-weight: 600;">
              <span class="material-icons">explore</span>
              Browse Profiles
            </a>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Loading State -->
    <div class="card" id="loading-state" style="display: none;">
      <div class="conversation-item" style="text-align: center; color: var(--muted);">
        <div>Loading messages...</div>
      </div>
    </div>
  </div>

  <script>
    // Message count badge management
    let messageCountInterval;
    
    function refreshMessageCount() {
      fetch("{% url 'messages_unread_count' %}")
        .then(r => {
          if (!r.ok) throw new Error('Network response was not ok');
          return r.json();
        })
        .then(data => {
          const badge = document.getElementById('msg-badge');
          if (data.count > 0) {
            badge.textContent = data.count > 99 ? '99+' : data.count;
            badge.style.display = 'flex';
            
            // Update page title with count
            document.title = `(${data.count}) GR8Date â€¢ Messages`;
          } else {
            badge.style.display = 'none';
            document.title = 'GR8Date â€¢ Messages';
          }
        })
        .catch(error => {
          console.error('Error fetching message count:', error);
          // Don't show error to user, just hide badge
          document.getElementById('msg-badge').style.display = 'none';
          document.title = 'GR8Date â€¢ Messages';
        });
    }

    // Enhanced message loading with better error handling
    function loadMessages() {
      const conversationsList = document.getElementById('conversations-list');
      const loadingState = document.getElementById('loading-state');
      
      if (conversationsList) {
        conversationsList.classList.add('loading');
      }
      loadingState.style.display = 'block';
      
      // Simulate API call - in real implementation, this would fetch from your backend
      setTimeout(() => {
        if (conversationsList) {
          conversationsList.classList.remove('loading');
        }
        loadingState.style.display = 'none';
        refreshMessageCount(); // Refresh count after loading messages
      }, 500);
    }

    // Mark conversation as read when user views the page
    function markAllAsRead() {
      fetch("{% url 'messages_list' %}", {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (response.ok) {
          // Messages are automatically marked as read by the Django view
          refreshMessageCount();
        }
      })
      .catch(error => {
        console.error('Error marking messages as read:', error);
      });
    }

    // Real-time updates for new messages (simplified version)
    function setupRealTimeUpdates() {
      // In a real implementation, you might use WebSockets or Server-Sent Events
      // For now, we'll use periodic polling
      messageCountInterval = setInterval(refreshMessageCount, 30000); // Every 30 seconds
    }

    // Handle page visibility changes to optimize polling
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        // Page is hidden, reduce polling frequency
        clearInterval(messageCountInterval);
        messageCountInterval = setInterval(refreshMessageCount, 60000); // Every 60 seconds when hidden
      } else {
        // Page is visible, resume normal polling
        clearInterval(messageCountInterval);
        messageCountInterval = setInterval(refreshMessageCount, 30000); // Every 30 seconds when visible
        refreshMessageCount(); // Immediate refresh when page becomes visible
      }
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Initial load
      refreshMessageCount();
      
      // Set up real-time updates
      setupRealTimeUpdates();
      
      // Mark messages as read
      markAllAsRead();
      
      // Add click handlers for better UX
      const conversationItems = document.querySelectorAll('.conversation-item');
      conversationItems.forEach(item => {
        item.addEventListener('click', function() {
          // Add visual feedback
          this.style.opacity = '0.7';
          
          // Remove unread styles after click (they'll be updated on next refresh)
          setTimeout(() => {
            this.classList.remove('unread-conversation');
            const unreadBadge = this.querySelector('.unread-badge');
            if (unreadBadge) {
              unreadBadge.remove();
            }
            const preview = this.querySelector('.conversation-preview');
            if (preview) {
              preview.classList.remove('unread-text');
            }
          }, 100);
        });
      });
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
      clearInterval(messageCountInterval);
    });

    // Handle network connectivity changes
    window.addEventListener('online', function() {
      console.log('Connection restored - refreshing messages');
      refreshMessageCount();
      setupRealTimeUpdates();
    });

    window.addEventListener('offline', function() {
      console.log('Connection lost - pausing updates');
      clearInterval(messageCountInterval);
    });

    // Enhanced error handling for access request actions
    document.addEventListener('click', function(e) {
      // Handle access request approve/deny buttons
      if (e.target.classList.contains('btn-success') || e.target.classList.contains('btn-danger')) {
        if (e.target.href) {
          e.preventDefault();
          const originalText = e.target.textContent;
          e.target.textContent = 'Processing...';
          e.target.disabled = true;
          
          fetch(e.target.href, {
            method: 'GET',
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => {
            if (response.ok) {
              // Remove the access request item
              e.target.closest('.conversation-item').style.opacity = '0';
              setTimeout(() => {
                e.target.closest('.conversation-item').remove();
                
                // Refresh message count as this might affect notifications
                refreshMessageCount();
                
                // Show success message
                if (e.target.classList.contains('btn-success')) {
                  showToast('Access request approved!');
                } else {
                  showToast('Access request denied.');
                }
              }, 300);
            } else {
              throw new Error('Request failed');
            }
          })
          .catch(error => {
            console.error('Error processing access request:', error);
            e.target.textContent = originalText;
            e.target.disabled = false;
            showToast('Failed to process request. Please try again.');
          });
        }
      }
    });

    // Toast notification function
    function showToast(message) {
      // Create toast element if it doesn't exist
      let toast = document.getElementById('global-toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'global-toast';
        toast.style.cssText = `
          position: fixed;
          top: 100px;
          left: 50%;
          transform: translateX(-50%);
          background: var(--brand);
          color: white;
          padding: 12px 20px;
          border-radius: 25px;
          font-weight: 600;
          z-index: 2003;
          box-shadow: 0 4px 12px rgba(255, 84, 120, 0.3);
          opacity: 0;
          transition: opacity 0.3s ease;
        `;
        document.body.appendChild(toast);
      }
      
      toast.textContent = message;
      toast.style.opacity = '1';
      
      setTimeout(() => {
        toast.style.opacity = '0';
      }, 3000);
    }

    // Search functionality (placeholder)
    document.addEventListener('DOMContentLoaded', function() {
      const searchBtn = document.querySelector('[data-open-search]');
      if (searchBtn) {
        searchBtn.addEventListener('click', function(e) {
          e.preventDefault();
          showToast('Search feature coming soon!');
        });
      }
    });
  </script>
</body>
</html>
