{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Create Hot Date</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    :root{
      --bg:#f7f7fb; --card:#fff; --border:#ececf3; --text:#1f2328; --muted:#6b7280;
      --brand:#ff3366; --brand-600:#ff2366; --radius:18px; --shadow:0 12px 26px rgba(15,23,42,.06)
    }
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}

    /* ===== Your Existing Header Styles ===== */
    .site-header{
      position:fixed; top:0; left:0; right:0; z-index:1000;
      background:#fff; border-bottom:1px solid var(--border);
      box-shadow:0 1px 0 rgba(15,23,42,.02);
    }
    .nav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px;min-height:56px;}
    .brand{font-weight:800; letter-spacing:.2px; font-size:22px; margin-right:auto;}
    .brand .date{color:var(--brand);}
    .top-icons{display:flex; gap:10px; align-items:center;}
    .icon-btn{
      position:relative;
      display:inline-flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:12px; background:#fff;
      border:1px solid var(--border); box-shadow:var(--shadow);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .icon-btn:hover{transform:translateY(-1px); box-shadow:0 12px 24px rgba(15,23,42,.12)}
    .icon-btn .material-icons{font-size:22px}
    .rot-90{transform: rotate(90deg); display:inline-block}

    /* Badge Styles */
    .badge{position:absolute;top:4px;right:6px;min-width:16px;height:16px;
      background:#ff5478;color:#fff;font-size:10px;font-weight:700;border-radius:999px;
      display:flex;align-items:center;justify-content:center}
    .flash{animation:pulse 1.4s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.7}}

    .spacer{height:56px;}

    /* Form Styles */
    .container{max-width:1100px;margin:0 auto;padding:16px}
    h1,h2{margin:.25rem 0 1rem}
    h1.title{font-weight:800;color:var(--brand);letter-spacing:.2px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:10px 16px;background:#fff;cursor:pointer}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn-ghost{background:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    
    /* Create form */
    .form-card{padding:0;overflow:hidden}
    .form-head{display:flex;align-items:center;justify-content:space-between;padding:16px 16px 0}
    .form-wrap{padding:0 16px 16px}
    .help{color:#111;background:#fffdfc;border:1px dashed #f6d2de;padding:10px 12px;border-radius:12px;margin:0 16px 12px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:760px){.form-grid{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    select,input[type="date"],input[type="time"],input[type="text"]{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
    .sticky-footer{position:sticky;bottom:0;background:#fff;padding:12px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
    .btn-wide{padding:14px 22px;border-radius:999px;font-weight:800}
  </style>
</head>
<body>

<!-- Your Existing Header -->
<header class="site-header">
  <div class="nav">
    <div class="brand"><span>GR8</span><span class="date">DATE</span></div>

    <div class="top-icons" aria-label="Header actions">
      <a class="icon-btn" href="{% url 'dashboard' %}" title="Dashboard">
        <span class="material-icons rot-90">u_turn_left</span>
      </a>
      <a class="icon-btn" href="#" data-open-search title="Search"><span class="material-icons">search</span></a>
      <a class="icon-btn" href="{% url 'messages_list' %}" title="Messages">
        <span class="material-icons">mail</span>
        <span class="badge" id="msg-badge" style="display: none;"></span>
      </a>
      <a class="icon-btn" href="{% url 'matches_list' %}" title="Matches"><span class="material-icons">groups</span></a>
      <a class="icon-btn" href="{% url 'hotdate_list' %}" title="Hot Dates">
        <span class="material-icons">local_fire_department</span>
        <span class="badge flash" id="hotdate-badge" style="display: none;"></span>
      </a>
      <a class="icon-btn" href="{% url 'profile_edit' %}" title="My Profile"><span class="material-icons">person</span></a>
      <a class="icon-btn" href="#" id="logout-btn" title="Logout"><span class="material-icons">logout</span></a>
    </div>
  </div>
</header>

<div class="spacer"></div>

<main class="container">
  <section class="card form-card">
    <div class="form-head">
      <h1 class="title">Create Hot Date</h1>
      <a class="btn" href="{% url 'hotdate_list' %}"><span class="material-icons">whatshot</span> View Hot Dates</a>
    </div>
    <p class="help"><strong>No free text.</strong> Host identity is taken from your profile. Audience controls who sees it.</p>
    <div class="form-wrap">
      <form id="hotForm" onsubmit="event.preventDefault(); alert('Submitted (client check passed)');">
        <div class="form-grid">
          <div class="field"><label>Activity</label>
            <select required>
              <option value="">Select an activity</option>
              <option>Coffee</option>
              <option>Drinks / Wine Bar</option>
              <option>Dinner</option>
              <option>Walk / Park</option>
              <option>Gallery / Museum</option>
              <option>Movie</option>
              <option>Live Music / Comedy</option>
              <option>Surprise Me</option>
            </select>
          </div>
          <div class="field"><label>Vibe</label>
            <select required>
              <option value="">Select a vibe</option>
              <option>Chill</option>
              <option>Classy</option>
              <option>Adventurous</option>
              <option>Playful</option>
              <option>Quiet</option>
            </select>
          </div>
          <div class="field"><label>Budget</label>
            <select required>
              <option value="">Select budget</option>
              <option>Free</option>
              <option>$</option>
              <option>$$</option>
              <option>$$$</option>
              <option>Each pays their way</option>
            </select>
          </div>
          <div class="field"><label>Duration</label>
            <select required>
              <option value="">Select duration</option>
              <option>45 min</option>
              <option>60 min</option>
              <option>90 min</option>
              <option>2 hours</option>
              <option>3 hours</option>
            </select>
          </div>
          <div class="field"><label>Date</label><input id="hdDate" type="date" required></div>
          <div class="field"><label>Time</label><input id="hdTime" type="time" required></div>
          <div class="field" style="grid-column:1/-1"><label>Area / Suburb</label>
            <input type="text" id="area" placeholder="Type to search (e.g., Willoughby)" required>
            <div class="muted" style="font-size:13px;margin-top:6px">Type‑ahead search across the AU suburb list; pick from results.</div>
          </div>
          <div class="field"><label>Group size</label>
            <select required>
              <option value="">Select group size</option>
              <option>1 on 1</option>
              <option>Small group (3–4)</option>
              <option>Group (5+)</option>
            </select>
          </div>
          <div class="field"><label>Audience</label>
            <select required>
              <option value="">Select audience</option>
              <option>Anyone</option>
              <option>Women only</option>
              <option>Men only</option>
            </select>
          </div>
        </div>
        <div class="sticky-footer">
          <button type="button" class="btn" onclick="document.getElementById('hotForm').reset()">Reset</button>
          <button class="btn btn-primary btn-wide" type="submit"><span class="material-icons">whatshot</span> Post Hot Date</button>
        </div>
      </form>
    </div>
  </section>
</main>

<script>
  // Client guard: block past and require 60+ minutes lead
  (function(){ 
    const d = document.getElementById('hdDate'), t = document.getElementById('hdTime');
    function setMin(){ 
      const now = new Date(); d.min = now.toISOString().slice(0,10);
      function updateTimeMin(){
        if(!d.value) return;
        const minLead = new Date(Date.now() + 60*60000);
        const todayStr = new Date().toISOString().slice(0,10);
        if(d.value === todayStr){ 
          const hh2 = String(minLead.getHours()).padStart(2,'0');
          const mi2 = String(minLead.getMinutes()).padStart(2,'0');
          t.min = `${hh2}:${mi2}`;
        } else { t.min = ''; }
      }
      d.addEventListener('change', updateTimeMin); updateTimeMin();
    }
    setMin();
    document.getElementById('hotForm').addEventListener('submit', function(ev){
      const date = d.value; const time = t.value; if(!date || !time) return;
      const start = new Date(date + 'T' + time); const lead = (start - new Date())/60000;
      if(lead < 60){ ev.preventDefault(); alert('Please choose a time at least 60 minutes from now.'); }
    });
  })();

  // Hot Dates notification badge functionality
  (function(){
    const hotdateBtn = document.querySelector('.icon-btn[title="Hot Dates"]');
    const badge = document.getElementById('hotdate-badge');
    if(!hotdateBtn || !badge) return;
    
    let lastCount = 0;
    const POLL_MS = 15000; // Check every 15 seconds

    async function checkNewHotDates() {
        try {
            const response = await fetch("{% url 'hotdates_new_count' %}", {
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                },
                credentials: "include"
            });
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            const currentCount = Number(data.count || 0);
            
            updateBadge(currentCount);
            
        } catch (error) {
            console.error('Error checking new Hot Dates:', error);
        } finally {
            setTimeout(checkNewHotDates, POLL_MS);
        }
    }
    
    function updateBadge(count) {
        if (count > 0) {
            badge.textContent = count > 99 ? "99+" : String(count);
            badge.style.display = 'flex';
            
            // Flash when count increases
            if (count > lastCount) {
                badge.classList.add('flash');
                setTimeout(() => badge.classList.remove('flash'), 3000);
            } else if (!badge.classList.contains('flash')) {
                badge.classList.add('flash');
            }
        } else {
            badge.style.display = 'none';
            badge.classList.remove('flash');
        }
        
        lastCount = count;
    }

    // Start the auto-refresh
    checkNewHotDates();
    
    // Refresh when page becomes visible
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            checkNewHotDates();
        }
    });
    
    // Refresh when window gains focus
    window.addEventListener('focus', checkNewHotDates);

})();
</script>

</body>
</html>
