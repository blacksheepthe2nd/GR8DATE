{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hot Dates</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    :root{
      --bg:#f7f7fb; --card:#fff; --border:#ececf3; --text:#1f2328; --muted:#6b7280;
      --brand:#ff3366; --brand-600:#ff2366; --radius:18px; --shadow:0 12px 26px rgba(15,23,42,.06)
    }
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}

    /* ===== Your Existing Header Styles ===== */
    .site-header{
      position:fixed; top:0; left:0; right:0; z-index:1000;
      background:#fff; border-bottom:1px solid var(--border);
      box-shadow:0 1px 0 rgba(15,23,42,.02);
    }
    .nav{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px;min-height:56px;}
    .brand{font-weight:800; letter-spacing:.2px; font-size:22px; margin-right:auto;}
    .brand .date{color:var(--brand);}
    .top-icons{display:flex; gap:10px; align-items:center;}
    .icon-btn{
      position:relative;
      display:inline-flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:12px; background:#fff;
      border:1px solid var(--border); box-shadow:var(--shadow);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .icon-btn:hover{transform:translateY(-1px); box-shadow:0 12px 24px rgba(15,23,42,.12)}
    .icon-btn .material-icons{font-size:22px}
    .rot-90{transform: rotate(90deg); display:inline-block}

    /* Badge Styles */
    .badge{position:absolute;top:4px;right:6px;min-width:16px;height:16px;
      background:#ff5478;color:#fff;font-size:10px;font-weight:700;border-radius:999px;
      display:flex;align-items:center;justify-content:center}
    .flash{animation:pulse 1.4s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.7}}

    .spacer{height:56px;}

    /* Hot Dates Content Styles */
    .container{max-width:1100px;margin:0 auto;padding:16px}
    h1,h2{margin:.25rem 0 1rem}
    h1.title{font-weight:800;color:var(--brand);letter-spacing:.2px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:10px 16px;background:#fff;cursor:pointer}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn-ghost{background:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    
    /* List cards */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:620px){.grid{grid-template-columns:1fr}}
    .hot-card{border-radius:16px;border:1px solid var(--border);background:#fff;box-shadow:var(--shadow);padding:14px}
    .hot-top{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .avatar{width:36px;height:36px;border-radius:999px;background:#ddd;overflow:hidden}
    .aud{margin-left:auto;background:#f2f4f7;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
    .title{font-weight:800;font-size:22px;line-height:1.15;margin:4px 0 8px}
    .meta{color:#374151;font-size:14px;margin:6px 0 10px}
    .bullets{color:#374151;font-size:14px}
    .bullets .dot::before{content:"â€¢ ";}
    .btn-row{display:flex;gap:10px;align-items:center;margin-top:10px}
    .badge-cancel{background:#ffe4e8;color:#b4232c;border:1px solid #ffd1dc;border-radius:999px;padding:4px 10px;font-size:12px}
    
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-state .material-icons{font-size:64px;color:#e5e7eb;margin-bottom:16px}
    
    /* Message Styles */
    .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:12px;border-radius:8px;margin-bottom:16px;}
    .alert-error{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24;padding:12px;border-radius:8px;margin-bottom:16px;}
    
    /* Seen row styles */
    .seen-row {
        margin: 8px 0 4px 0;
        display: flex;
        justify-content: flex-end;
    }
    
    .mark-seen {
        font-size: 12px;
        padding: 6px 12px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .mark-seen:hover {
        background: #e9ecef;
    }
    
    /* Hover effects for buttons */
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Cancel Hot Date Modal */
    .cancel-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }
    .cancel-modal-content {
      background: white;
      border-radius: 16px;
      width: 90vw;
      max-width: 400px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .cancel-modal h3 {
      margin: 0 0 16px 0;
      font-size: 1.3em;
      color: #333;
    }
    .cancel-modal p {
      margin: 0 0 24px 0;
      color: #666;
      line-height: 1.5;
    }
    .cancel-modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .cancel-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      min-width: 100px;
    }
    .cancel-confirm {
      background: #ff5478;
      color: white;
    }
    .cancel-cancel {
      background: #f1f5f9;
      color: #64748b;
      border: 1px solid #e2e8f0;
    }
    /* Logout Modal Styles */
.logout-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 10001;
  align-items: center;
  justify-content: center;
}
.logout-modal-content {
  background: white;
  border-radius: 16px;
  width: 90vw;
  max-width: 400px;
  padding: 24px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.logout-modal h3 {
  margin: 0 0 16px 0;
  font-size: 1.3em;
  color: #333;
}
.logout-modal p {
  margin: 0 0 24px 0;
  color: #666;
  line-height: 1.5;
}
.logout-modal-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
}
.logout-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  min-width: 100px;
}
.logout-confirm {
  background: #ff5478;
  color: white;
  text-decoration: none;
  display: inline-block;
}
.logout-cancel {
  background: #f1f5f9;
  color: #64748b;
  border: 1px solid #e2e8f0;
}
  </style>
</head>
<body>

<!-- Your Existing Header -->
<header class="site-header">
  <div class="nav">
    <div class="brand"><span>GR8</span><span class="date">DATE</span></div>

    <div class="top-icons" aria-label="Header actions">
      <a class="icon-btn" href="{% url 'dashboard' %}" title="Dashboard">
        <span class="material-icons rot-90">u_turn_left</span>
      </a>
      <a class="icon-btn" href="#" data-open-search title="Search"><span class="material-icons">search</span></a>
      <a class="icon-btn" href="{% url 'messages_list' %}" title="Messages">
        <span class="material-icons">mail</span>
        <span class="badge" id="msg-badge" style="display: none;"></span>
      </a>
      <a class="icon-btn" href="{% url 'matches_list' %}" title="Matches"><span class="material-icons">groups</span></a>
      <a class="icon-btn" href="{% url 'hotdate_list' %}" title="Hot Dates">
        <span class="material-icons">local_fire_department</span>
        <span class="badge flash" id="hotdate-badge" style="display: none;"></span>
      </a>
      <a class="icon-btn" href="{% url 'profile_edit' %}" title="My Profile"><span class="material-icons">person</span></a>
      <a class="icon-btn" href="#" id="logout-btn" title="Logout"><span class="material-icons">logout</span></a>
    </div>
  </div>
</header>

<div class="spacer"></div>

<main class="container">
  <!-- Success/Error Messages -->
  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <div class="alert-{% if message.tags == 'success' %}success{% else %}error{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <section class="row" style="justify-content:space-between">
    <h1 class="title">Hot Dates</h1>
    <a class="btn btn-primary" href="{% url 'hotdate_create' %}"><span class="material-icons">add</span> Create Hot Date</a>
  </section>
  
  <section class="grid">
    {% if hot_dates %}
      {% for hot_date in hot_dates %}
      <article class="hot-card">
        <div class="hot-top">
          <div class="avatar">
            {% if hot_date.host.profile.primary_image %}
              <img src="{{ hot_date.host.profile.primary_image.url }}" alt="" style="width:100%;height:100%;object-fit:cover">
            {% else %}
              <div style="width:100%;height:100%;background:#ddd;display:flex;align-items:center;justify-content:center;">
                <span class="material-icons">person</span>
              </div>
            {% endif %}
          </div>
          <div>
            <a href="{% url 'profile_detail' hot_date.host.id %}" style="font-weight:bold; color:inherit;">
              <strong>{{ hot_date.host.username }}</strong>
            </a>
            <div class="muted" style="font-size:12px;margin-top:-2px">Host</div>
          </div>
          <div class="aud">Audience: {{ hot_date.get_audience_display }}</div>
        </div>
        <div class="title">{{ hot_date.title }}</div>
        <div class="meta">{{ hot_date.date_time|date:"D, M j â€¢ H:i" }} â€¢ {{ hot_date.duration }}</div>
        <div class="bullets">
          <div class="dot">Area: {{ hot_date.area }}</div>
          <div class="dot">Budget: {{ hot_date.budget }}</div>
          <div class="dot">Group: {{ hot_date.get_group_size_display }}</div>
        </div>

        <!-- Mark as Seen button - only show if user hasn't seen this Hot Date yet -->
        {% if hot_date.id not in viewed_hotdates %}
        <div class="seen-row">
          <button class="btn btn-ghost mark-seen" data-hotdate-id="{{ hot_date.id }}" style="font-size:12px; padding:6px 12px;">
            <span class="material-icons" style="font-size:16px;">visibility</span>
            Mark as Seen
          </button>
        </div>
        {% endif %}

        <div class="btn-row">
          <!-- Message Host - opens message thread with host -->
          <a class="btn" href="{% url 'message_thread' hot_date.host.id %}" data-hotdate-id="{{ hot_date.id }}">
            Message Host
          </a>
          
          <!-- Cancel - only show for host's own Hot Dates -->
          {% if hot_date.host == request.user %}
            <button class="btn cancel-hotdate" data-hotdate-id="{{ hot_date.id }}">
              Cancel
            </button>
          {% endif %}
        </div>
      </article>
      {% endfor %}
    {% else %}
      <!-- No Hot Dates -->
      <div class="empty-state">
        <span class="material-icons">local_fire_department</span>
        <h3>No Hot Dates Yet</h3>
        <p>Be the first to create a Hot Date and meet new people!</p>
        <a class="btn btn-primary" href="{% url 'hotdate_create' %}" style="margin-top:16px">
          <span class="material-icons">add</span> Create Your First Hot Date
        </a>
      </div>
    {% endif %}
  </section>
</main>

<!-- Cancel Hot Date Confirmation Modal -->
<div id="cancelHotDateModal" class="cancel-modal">
  <div class="cancel-modal-content">
    <h3>Cancel Hot Date?</h3>
    <p>Are you sure you want to cancel this Hot Date? This action cannot be undone.</p>
    <div class="cancel-modal-buttons">
      <button class="cancel-btn cancel-cancel" id="cancelHotDateCancel">Keep Hot Date</button>
      <button class="cancel-btn cancel-confirm" id="cancelHotDateConfirm">Yes, Cancel</button>
    </div>
  </div>
</div>

<!-- Logout Confirmation Modal -->
<div id="logoutModal" class="logout-modal">
  <div class="logout-modal-content">
    <h3>Log Out?</h3>
    <p>Are you sure you want to log out? You'll need to log in again to access your account.</p>
    <div class="logout-modal-buttons">
      <button class="logout-btn logout-cancel" id="logoutCancel">Cancel</button>
      <a href="{% url 'logout' %}" class="logout-btn logout-confirm" id="logoutConfirm">Log Out</a>
    </div>
  </div>
</div>

<script>
// Hot Dates notification badge functionality
(function(){
    const hotdateBtn = document.querySelector('.icon-btn[title="Hot Dates"]');
    const badge = document.getElementById('hotdate-badge');
    if(!hotdateBtn || !badge) return;
    
    let lastCount = 0;
    const POLL_MS = 15000; // Check every 15 seconds

    async function checkNewHotDates() {
        try {
            const response = await fetch("{% url 'hotdates_new_count' %}", {
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                },
                credentials: "include"
            });
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            const currentCount = Number(data.count || 0);
            
            updateBadge(currentCount);
            
        } catch (error) {
            console.error('Error checking new Hot Dates:', error);
        } finally {
            setTimeout(checkNewHotDates, POLL_MS);
        }
    }
    
    function updateBadge(count) {
        if (count > 0) {
            badge.textContent = count > 99 ? "99+" : String(count);
            badge.style.display = 'flex';
            
            // Flash when count increases
            if (count > lastCount) {
                badge.classList.add('flash');
                setTimeout(() => badge.classList.remove('flash'), 3000);
            } else if (!badge.classList.contains('flash')) {
                badge.classList.add('flash');
            }
        } else {
            badge.style.display = 'none';
            badge.classList.remove('flash');
        }
        
        lastCount = count;
    }

    // Additional refresh triggers
    function refreshOnVisibilityChange() {
        if (!document.hidden) {
            checkNewHotDates();
        }
    }

    function refreshOnFocus() {
        checkNewHotDates();
    }

    // Start the auto-refresh
    checkNewHotDates();
    
    // Refresh when page becomes visible
    document.addEventListener('visibilitychange', refreshOnVisibilityChange);
    
    // Refresh when window gains focus
    window.addEventListener('focus', refreshOnFocus);
    
    // Refresh when navigating back to page
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            checkNewHotDates();
        }
    });

})();

// Hot Date button functionality
document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token for AJAX requests
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    // Cancel Hot Date with professional confirmation modal
    document.querySelectorAll('.cancel-hotdate').forEach(btn => {
        btn.addEventListener('click', function() {
            const hotdateId = this.getAttribute('data-hotdate-id');
            const modal = document.getElementById('cancelHotDateModal');
            const confirmBtn = document.getElementById('cancelHotDateConfirm');
            const cancelBtn = document.getElementById('cancelHotDateCancel');
            
            // Store the hotdate ID for the confirm action
            confirmBtn.setAttribute('data-hotdate-id', hotdateId);
            
            // Show the modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Confirm cancellation
            confirmBtn.onclick = function() {
                const hotdateId = this.getAttribute('data-hotdate-id');
                console.log('Cancel Hot Date:', hotdateId);
                // Here you would call an API to cancel the Hot Date
                modal.style.display = 'none';
                document.body.style.overflow = '';
                window.location.reload();
            };
            
            // Cancel button
            cancelBtn.onclick = function() {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            };
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            });
            
            // Close with ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'flex') {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            });
        });
    });
    
    // Mark Hot Date as seen
    document.querySelectorAll('.mark-seen').forEach(btn => {
        btn.addEventListener('click', function() {
            const hotdateId = this.getAttribute('data-hotdate-id');
            
            fetch(`/hotdates/${hotdateId}/mark-seen/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the mark as seen button
                    this.style.display = 'none';
                    // Refresh the badge count
                    checkNewHotDates();
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
    
     // Logout Confirmation
document.addEventListener('DOMContentLoaded', function() {
  const logoutBtn = document.getElementById('logout-btn');
  const logoutModal = document.getElementById('logoutModal');
  const logoutCancel = document.getElementById('logoutCancel');

  if (logoutBtn && logoutModal) {
    // Open modal when logout button is clicked
    logoutBtn.addEventListener('click', function(e) {
      e.preventDefault();
      logoutModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    });

    // Close modal when cancel button is clicked
    logoutCancel.addEventListener('click', function() {
      logoutModal.style.display = 'none';
      document.body.style.overflow = '';
    });

    // Close modal when clicking outside
    logoutModal.addEventListener('click', function(e) {
      if (e.target === logoutModal) {
        logoutModal.style.display = 'none';
        document.body.style.overflow = '';
      }
    });

    // Close with ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && logoutModal.style.display === 'flex') {
        logoutModal.style.display = 'none';
        document.body.style.overflow = '';
      }
    });
  }
});

    // Mark as seen when user clicks Message Host
    document.querySelectorAll('a[href*="message_thread"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const hotdateId = this.getAttribute('data-hotdate-id');
            
            if (hotdateId) {
                // Mark as seen in background
                fetch(`/hotdates/${hotdateId}/mark-seen/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include'
                });
            }
        });
    });
});
</script>

</body>
</html>
