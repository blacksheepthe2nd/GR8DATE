{% extends "base_header.html" %}

{% block title %}GR8DATE • Create Your Profile{% endblock %}

{% block content %}
</div>
<style>
:root{--brand:#ff2b6a;--brand-900:#e11e5a;--ink:#0f172a;--muted:#64748b;--bg:#f6f7fb;--card:#fff;--border:#eaeef5;--shadow:0 10px 26px rgba(15,23,42,.08)}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
.container{max-width:1120px;margin:24px auto;padding:0 16px 80px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:760px){.grid-2{grid-template-columns:1fr}}
.field{display:flex;flex-direction:column;gap:6px}
.field input,.field select,.field textarea{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
.read-only{background:#fbfbfd}
.btn{display:inline-flex;align-items:center;gap:8px;border-radius:9999px;padding:.7rem 1.1rem;border:2px solid transparent;font-weight:700;cursor:pointer}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-primary:hover{background:var(--brand-900);border-color:var(--brand-900)}
.btn-muted{background:#f2f4f7;border:1px solid var(--border);color:#111}
.btn-disabled{background:#e5e7eb;color:#9ca3af;border-color:#d1d5db;cursor:not-allowed}

/* PROPER BUTTON TABS */
.mobile-tabs{display:flex;background:#f8f9fa;padding:8px;border-radius:12px;margin-bottom:20px;border:1px solid var(--border)}
.tab-button{flex:1;padding:12px 16px;border:none;background:transparent;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px}
.tab-button.active{background:white;box-shadow:0 2px 8px rgba(0,0,0,.1);border:1px solid var(--border);color:var(--brand)}
.tab-button:not(.active):hover{background:rgba(255,255,255,0.7)}
.tab-button.disabled{opacity:0.5;cursor:not-allowed}
.settings-section{display:none}
.settings-section.active{display:block}

/* Badges & Status */
.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;margin-left:8px}
.badge-required{background:#fee2e2;color:#dc2626}
.badge-pending{background:#fef3c7;color:#92400e}

/* UPDATED PHOTO STYLES WITH CROPPER */
.photo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.photo-item{position:relative;width:100%;aspect-ratio:1/1;border-radius:10px;overflow:hidden;border:2px dashed #ccc;display:flex;align-items:center;justify-content:center;background:#f0f0f0;cursor:pointer}
.photo-item img{width:100%;height:100%;object-fit:cover}
.btn-delete{position:absolute;top:5px;right:5px;width:20px;height:20px;background:#ff4444;color:white;border:none;border-radius:50%;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center}
.add-photo-btn{background:#e8f4ff;border:2px dashed #667eea;color:#667eea;font-weight:bold;font-size:1.5rem}
.photo-count{font-size:12px;color:#64748b;margin-top:6px}

/* FIXED CROPPER MODAL STYLES */
.cropper-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}
.cropper-content {
    background: white;
    padding: 24px;
    border-radius: 16px;
    max-width: 95%;
    max-height: 95%;
    width: 800px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    border: 2px solid #fff;
}
.cropper-preview {
    width: 100%;
    max-height: 500px;
    margin: 16px 0;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #fff;
}
.cropper-controls {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
    align-items: center;
}
.cropper-zoom {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}
.cropper-zoom input {
    width: 120px;
}

/* Photo preview thumbnails */
.photo-thumbnail {
    position: relative;
    width: 100%;
    aspect-ratio: 1/1;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid var(--border);
}
.photo-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Tag options styles */
.tag-options{display:flex;flex-wrap:wrap;gap:8px;border:1px solid var(--border);border-radius:10px;padding:12px;background:var(--bg-muted);min-height:60px}
.tag-option{display:flex;align-items:center;padding:6px 12px;background:white;border:2px solid #e9ecef;border-radius:20px;cursor:pointer;transition:all 0.3s}
.tag-option:hover{border-color:#667eea;background:#f0f4ff}
.tag-option input[type="checkbox"]{margin-right:6px}
.tag-option input[type="checkbox"]:checked + span{font-weight:bold;color:#667eea}

.badge-note{font-size:12px;color:#64748b;margin-top:6px}

/* Save Actions */
.save-actions{display:flex;flex-direction:column;gap:12px;margin-top:20px;padding:16px;background:#f8f9fa;border-radius:12px;border:1px solid #eaeef5}
.save-main{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center}

/* Username validation */
.username-status{margin-top:4px;font-size:12px}
.username-available{color:#166534}
.username-taken{color:#dc2626}
.username-checking{color:#64748b}

/* Validation styles */
.field-required label::after{content:" *";color:#dc2626}
.validation-error{border-color:#dc2626 !important;background:#fef2f2}
.error-message{color:#dc2626;font-size:12px;margin-top:4px}
.tab-progress{display:flex;justify-content:center;gap:8px;margin-bottom:16px}
.progress-dot{width:8px;height:8px;border-radius:50%;background:#e5e7eb;transition:all 0.3s}
.progress-dot.active{background:var(--brand)}
.progress-dot.completed{background:#10b981}

/* Success Modal */
.success-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}
.success-modal-content {
    background: white;
    padding: 32px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}
.success-icon {
    font-size: 48px;
    color: #10b981;
    margin-bottom: 16px;
}
.success-title {
    font-size: 24px;
    font-weight: 700;
    margin: 0 0 16px 0;
    color: var(--ink);
}
.success-message {
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 24px;
}
</style>

<!-- Add Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

<main class="container">
  <!-- ADMIN REVIEW NOTICE -->
  <div class="card" style="background:#fff3cd;border-color:#ffeaa7;margin-bottom:16px;">
    <div style="display:flex;align-items:center;gap:8px;">
      <span class="material-icons" style="color:#856404">admin_panel_settings</span>
      <div>
        <strong>All profile content requires admin approval</strong>
        <div style="font-size:14px;color:#856404">Complete all sections to submit your profile for review</div>
      </div>
    </div>
  </div>

  <!-- FIXED IMAGE CROPPER MODAL -->
  <div id="cropperModal" class="cropper-modal">
    <div class="cropper-content">
      <h3 style="margin:0 0 16px 0; color: #000;">Crop Your Photo</h3>
      <div class="cropper-preview">
        <img id="imageToCrop" src="" style="max-width:100%; display: block;">
      </div>
      <div class="cropper-controls">
        <div class="cropper-zoom">
          <span class="material-icons" style="color: #000;">zoom_out</span>
          <input type="range" id="zoomSlider" min="0.1" max="3" step="0.1" value="1" style="color: #000;">
          <span class="material-icons" style="color: #000;">zoom_in</span>
        </div>
        <button type="button" class="btn btn-muted" onclick="cancelCrop()">
          <span class="material-icons">close</span>
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="applyCrop()">
          <span class="material-icons">check</span>
          Apply Crop
        </button>
      </div>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div id="successModal" class="success-modal">
    <div class="success-modal-content">
      <div class="success-icon">🎉</div>
      <h2 class="success-title">Congratulations!</h2>
      <p class="success-message">
        GR8DATE has received your profile and will endeavour to approve it soonest. 
        We will send you an email regarding this.<br><br>
        <strong>Please check your spam/junk mail box occasionally.</strong>
      </p>
      <button type="button" class="btn btn-primary" onclick="closeSuccessModal()">
        <span class="material-icons">check</span>
        Got It
      </button>
    </div>
  </div>

  <!-- PROGRESS INDICATOR -->
  <div class="tab-progress">
    <div class="progress-dot active" id="progress-basic"></div>
    <div class="progress-dot" id="progress-preferences"></div>
    <div class="progress-dot" id="progress-profile"></div>
  </div>

  <!-- PROPER BUTTON TABS -->
  <div class="mobile-tabs">
    <button class="tab-button active" data-tab="basic-info">
      <span class="material-icons" style="font-size:18px">person</span>
      Basic Info
    </button>
    <button class="tab-button disabled" data-tab="preferences" id="preferences-tab-btn">
      <span class="material-icons" style="font-size:18px">flash_on</span>
      Preferences
    </button>
    <button class="tab-button disabled" data-tab="profile-content" id="profile-tab-btn">
      <span class="material-icons" style="font-size:18px">edit</span>
      Profile & Photos
    </button>
  </div>

  <!-- REAL FORM -->
  <form id="profileForm" method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <!-- Clean header -->
    <div class="card" style="margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <h1 style="margin:0;font-size:22px">Create Your Profile</h1>
      <span class="badge badge-required">
        <span class="material-icons" style="font-size:14px">error</span>
        All Fields Required
      </span>
    </div>

    <!-- BASIC INFO SECTION - ALL FIELDS REQUIRED -->
    <div class="settings-section active" id="basic-info-tab">
      <section class="card">
        <div class="section-header" style="display:flex;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">👤 Basic Information</h3>
        </div>
        
        <div class="grid-2">
          <!-- Username with real-time validation -->
          <div class="field field-required">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" placeholder="Choose a username" required 
                   oninput="checkUsernameAvailability(this.value); validateBasicInfo()">
            <div id="username-status" class="username-status"></div>
            <small class="badge-note">This will be your public profile name</small>
          </div>

          <!-- Age - MANUAL ENTRY ONLY -->
          <div class="field field-required">
            <label for="age">Age</label>
            <input type="number" id="age" name="age" min="18" max="80" placeholder="Your age" required
                   oninput="validateBasicInfo()">
            <small class="badge-note">Must be 18 or older - enter your preferred age</small>
          </div>

          <!-- My Gender -->
          <div class="field field-required">
            <label for="my_gender">My Gender</label>
            <select id="my_gender" name="my_gender" required onchange="validateBasicInfo()">
              <option value="">Select your gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
              <option value="prefer_not">Prefer not to say</option>
            </select>
          </div>

          <!-- Looking For -->
          <div class="field field-required">
            <label for="looking_for">I'm Looking For</label>
            <select id="looking_for" name="looking_for" required onchange="validateBasicInfo()">
              <option value="">Select who you'd like to meet</option>
              <option value="men">Men</option>
              <option value="women">Women</option>
              <option value="both">Both</option>
              <option value="any">Any</option>
            </select>
            <small class="badge-note">This determines which profiles you can view</small>
          </div>

          <!-- Email (read-only) -->
          <div class="field">
            <label>Email</label>
            <input class="read-only" value="{{ user.email }}" readonly>
            <small class="badge-note">Your account email</small>
          </div>

          <!-- Date of Birth - FOR DEMOGRAPHICS ONLY -->
          <div class="field field-required">
            <label for="date_of_birth">Date of Birth</label>
            <input type="date" id="date_of_birth" name="date_of_birth" required
                   onchange="validateBasicInfo()">
            <small class="badge-note">For demographics & birthday wishes only - won't affect displayed age</small>
          </div>
        </div>

        <!-- Continue button -->
        <div class="save-actions">
          <div class="save-main">
            <button type="button" class="btn btn-primary" id="continue-to-preferences" onclick="switchToTab('preferences')" disabled>
              <span class="material-icons">arrow_forward</span>
              Continue to Preferences
            </button>
          </div>
          <div id="basic-info-errors" class="error-message"></div>
        </div>
      </section>
    </div>

    <!-- PREFERENCES SECTION - ALL FIELDS REQUIRED -->
    <div class="settings-section" id="preferences-tab">
      <section class="card">
        <div class="section-header" style="display:flex;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">⚡ Lifestyle & Preferences</h3>
        </div>
        
        <div class="grid-2">
          <!-- Lifestyle Preferences - ALL REQUIRED -->
          <div class="field field-required">
            <label>Smoking</label>
            <select name="smoking" required onchange="validatePreferences()">
              <option value="">Select preference</option>
              <option value="no">No</option>
              <option value="occasionally">Occasionally</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div class="field field-required">
            <label>Drinking</label>
            <select name="drinking" required onchange="validatePreferences()">
              <option value="">Select preference</option>
              <option value="no">No</option>
              <option value="socially">Socially</option>
              <option value="often">Often</option>
            </select>
          </div>
          <div class="field field-required">
            <label>Exercise</label>
            <select name="exercise" required onchange="validatePreferences()">
              <option value="">Select frequency</option>
              <option value="never">Never</option>
              <option value="sometimes">Sometimes</option>
              <option value="regularly">Regularly</option>
            </select>
          </div>
          <div class="field field-required">
            <label>Pets</label>
            <select name="pets" required onchange="validatePreferences()">
              <option value="">Select preference</option>
              <option value="no_pets">No pets</option>
              <option value="cat">Cat</option>
              <option value="dog">Dog</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="field field-required">
            <label>Diet</label>
            <select name="diet" required onchange="validatePreferences()">
              <option value="">Select diet</option>
              <option value="anything">Anything</option>
              <option value="vegetarian">Vegetarian</option>
              <option value="vegan">Vegan</option>
              <option value="halal">Halal</option>
              <option value="kosher">Kosher</option>
              <option value="pescatarian">Pescatarian</option>
            </select>
          </div>
          <div class="field field-required">
            <label>Children</label>
            <select name="children" required onchange="validatePreferences()">
              <option value="">Select status</option>
              <option value="yes">Have children</option>
              <option value="none">No children</option>
              <option value="want">Want children</option>
              <option value="dont_want">Don't want children</option>
            </select>
          </div>

          <!-- Age Range Preference -->
          <div class="field field-required">
            <label>Preferred Age Range</label>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="prefAgeMin" name="preferred_age_min" required onchange="validatePreferences()">
                <option value="">Min age</option>
                {% for age in ages %}
                <option value="{{ age }}">{{ age }}</option>
                {% endfor %}
              </select>
              <span>to</span>
              <select id="prefAgeMax" name="preferred_age_max" required onchange="validatePreferences()">
                <option value="">Max age</option>
                {% for age in ages %}
                <option value="{{ age }}">{{ age }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Distance Preference -->
          <div class="field field-required">
            <label>Distance Preference</label>
            <select id="prefDistance" name="preferred_distance" required onchange="validatePreferences()">
              <option value="">Select distance</option>
              <option value="5">5 km</option>
              <option value="10">10 km</option>
              <option value="25">25 km</option>
              <option value="50">50 km</option>
              <option value="100">100 km</option>
              <option value="country">Countrywide</option>
              <option value="any">Any</option>
            </select>
          </div>

          <!-- Intent Preference -->
          <div class="field field-required">
            <label>What Are You Looking For?</label>
            <select id="prefIntent" name="preferred_intent" required onchange="validatePreferences()">
              <option value="">Select intent</option>
              <option value="friends">New friends</option>
              <option value="casual">Casual dating</option>
              <option value="longterm">Long-term relationship</option>
              <option value="marriage">Marriage</option>
              <option value="any">Any</option>
            </select>
          </div>

          <!-- My Interests Tags - AT LEAST ONE REQUIRED -->
          <div class="field field-required" style="grid-column:1/-1">
            <label>My Interests (select at least one)</label>
            <div class="tag-options" id="interests-container">
              <label class="tag-option"><input type="checkbox" name="my_interests" value="hiking" onchange="validatePreferences()"><span>Hiking</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="beach" onchange="validatePreferences()"><span>Beach</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="dogs" onchange="validatePreferences()"><span>Dogs</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="books" onchange="validatePreferences()"><span>Books</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="music" onchange="validatePreferences()"><span>Music</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="travel" onchange="validatePreferences()"><span>Travel</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="movies" onchange="validatePreferences()"><span>Movies</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="gaming" onchange="validatePreferences()"><span>Gaming</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="cooking" onchange="validatePreferences()"><span>Cooking</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="fitness" onchange="validatePreferences()"><span>Fitness</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="art" onchange="validatePreferences()"><span>Art</span></label>
              <label class="tag-option"><input type="checkbox" name="my_interests" value="technology" onchange="validatePreferences()"><span>Technology</span></label>
            </div>
            <div id="interests-error" class="error-message"></div>
          </div>

          <!-- Must-Have Tags - AT LEAST ONE REQUIRED -->
          <div class="field field-required" style="grid-column:1/-1">
            <label>Must-Have Qualities (select at least one)</label>
            <div class="tag-options" id="must-have-container">
              <label class="tag-option"><input type="checkbox" name="must_have_tags" value="honest" onchange="validatePreferences()"><span>Honest</span></label>
              <label class="tag-option"><input type="checkbox" name="must_have_tags" value="kind" onchange="validatePreferences()"><span>Kind</span></label>
              <label class="tag-option"><input type="checkbox" name="must_have_tags" value="ambitious" onchange="validatePreferences()"><span>Ambitious</span></label>
              <label class="tag-option"><input type="checkbox" name="must_have_tags" value="humorous" onchange="validatePreferences()"><span>Humorous</span></label>
              <label class="tag-option"><input type="checkbox" name="must_have_tags" value="adventurous" onchange="validatePreferences()"><span>Adventurous</span></label>
              <label class="tag-option"><input type="checkbox" name="must_have_tags" value="loyal" onchange="validatePreferences()"><span>Loyal</span></label>
              <label class="tag-option"><input type="checkbox" name="must_have_tags" value="compassionate" onchange="validatePreferences()"><span>Compassionate</span></label>
              <label class="tag-option"><input type="checkbox" name="must_have_tags" value="confident" onchange="validatePreferences()"><span>Confident</span></label>
            </div>
            <div id="must-have-error" class="error-message"></div>
          </div>
        </div>

        <!-- Continue button -->
        <div class="save-actions">
          <div class="save-main">
            <button type="button" class="btn btn-muted" onclick="switchToTab('basic-info')">
              <span class="material-icons">arrow_back</span>
              Back to Basic Info
            </button>
            <button type="button" class="btn btn-primary" id="continue-to-profile" onclick="switchToTab('profile-content')" disabled>
              <span class="material-icons">arrow_forward</span>
              Continue to Profile & Photos
            </button>
          </div>
          <div id="preferences-errors" class="error-message"></div>
        </div>
      </section>
    </div>

    <!-- PROFILE & PHOTOS SECTION - MINIMUM REQUIREMENTS -->
    <div class="settings-section" id="profile-content-tab">
      <section class="card">
        <div class="section-header" style="display:flex;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">📸 Profile & Photos</h3>
        </div>

        <!-- Profile Photo Section - REQUIRED -->
        <div class="field field-required">
          <label>Profile Photo (required)</label>
          <div style="display:flex;align-items:center;gap:20px;margin-bottom:10px;">
            <div class="photo-item add-photo-btn" style="border:2px solid #667eea; width:120px; height:120px;" onclick="addProfilePhoto()" id="profile-photo-container">
              <span>+</span>
            </div>
            <div>
              <div style="font-weight:600;margin-bottom:4px">Add your profile photo</div>
              <div style="font-size:14px;color:#64748b">This will be your main profile picture - drag to position and zoom to crop</div>
            </div>
          </div>
          <div id="profile-photo-error" class="error-message"></div>
        </div>

        <!-- Additional Photos Section - OPTIONAL -->
        <div class="field">
          <label>Additional Photos (optional)</label>
          <div class="photo-grid" id="additional-photos-container">
            <div class="photo-item add-photo-btn" onclick="addAdditionalPhoto()">
              <span>+</span>
            </div>
          </div>
          <div class="photo-count"><span id="additional-count">0</span>/4 additional photos</div>
        </div>

        <!-- Private Photos Section - OPTIONAL -->
        <div class="field">
          <label>Private Photos (optional)</label>
          <div class="photo-grid" id="private-photos-container">
            <div class="photo-item add-photo-btn" onclick="addPrivatePhoto()">
              <span>+</span>
            </div>
          </div>
          <div class="photo-count"><span id="private-count">0</span>/4 private photos</div>
          <small class="badge-note" style="color:#dc2626;margin-top:8px">⚠️ Private photos will only be visible to users you approve</small>
        </div>

        <!-- Text Content Fields - ALL REQUIRED -->
        <div class="grid-2" style="margin-top:20px">
          <div class="field field-required">
            <label>Headline</label>
            <input name="headline" placeholder="Short tagline about yourself" required
                   oninput="validateProfileContent()">
            <small class="badge-note">A catchy phrase that represents you</small>
          </div>

          <div class="field field-required">
            <label>Location</label>
            <input name="location" placeholder="City / Suburb" required
                   oninput="validateProfileContent()">
            <small class="badge-note">Where you're located</small>
          </div>

          <div class="field field-required" style="grid-column:1/-1">
            <label>About Me</label>
            <textarea name="about" rows="6" placeholder="Tell people about you..." required
                      oninput="validateProfileContent()"></textarea>
            <small class="badge-note">Share your story, interests, and what you're looking for</small>
          </div>
        </div>

        <!-- Hidden fields for uploaded photos -->
        <input type="hidden" name="profile_photo_id" id="profile_photo_id" value="">
        <input type="hidden" name="additional_photo_ids" id="additional_photo_ids" value="">
        <input type="hidden" name="private_photo_ids" id="private_photo_ids" value="">

        <!-- Final Save button -->
        <div class="save-actions">
          <div class="save-main">
            <button type="button" class="btn btn-muted" onclick="switchToTab('preferences')">
              <span class="material-icons">arrow_back</span>
              Back to Preferences
            </button>
            <button type="submit" class="btn btn-primary" id="submit-profile" disabled>
              <span class="material-icons">rocket_launch</span>
              Submit Profile for Approval
            </button>
          </div>
          <div id="profile-errors" class="error-message"></div>
        </div>
      </section>
    </div>
  </form>
</main>

<!-- Add Cropper.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
// Global variables to track uploaded photos and cropper instance
let profilePhotoUploaded = false;
let uploadedPhotos = {
    profile: null,
    additional: [], // Now stores objects with id and url
    private: []     // Now stores objects with id and url
};
let currentCropper = null;
let currentPhotoType = null;
let currentFile = null;

// Tab switching with validation
function switchToTab(tabName) {
    // Validate current tab before switching
    let canSwitch = true;
    
    if (tabName === 'preferences') {
        canSwitch = validateBasicInfo(true);
    } else if (tabName === 'profile-content') {
        canSwitch = validatePreferences(true);
    }
    
    if (!canSwitch) {
        alert('Please complete all required fields before continuing.');
        return;
    }
    
    // Update progress dots
    updateProgressDots(tabName);
    
    // Update active tab button
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'disabled');
        if (btn.getAttribute('data-tab') === tabName) {
            btn.classList.add('active');
        }
    });
    
    // Enable next tabs
    if (tabName === 'basic-info') {
        document.getElementById('preferences-tab-btn').classList.remove('disabled');
    } else if (tabName === 'preferences') {
        document.getElementById('profile-tab-btn').classList.remove('disabled');
    }
    
    // Show corresponding section
    document.querySelectorAll('.settings-section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(tabName + '-tab').classList.add('active');
}

// Progress indicator
function updateProgressDots(currentTab) {
    const dots = {
        'basic-info': 'progress-basic',
        'preferences': 'progress-preferences', 
        'profile-content': 'progress-profile'
    };
    
    Object.entries(dots).forEach(([tab, dotId]) => {
        const dot = document.getElementById(dotId);
        if (tab === currentTab) {
            dot.className = 'progress-dot active';
        } else if (
            (currentTab === 'preferences' && tab === 'basic-info') ||
            (currentTab === 'profile-content' && (tab === 'basic-info' || tab === 'preferences'))
        ) {
            dot.className = 'progress-dot completed';
        } else {
            dot.className = 'progress-dot';
        }
    });
}

// STRICT Basic Info Validation
function validateBasicInfo(showErrors = false) {
    const errors = [];
    const fields = ['username', 'age', 'my_gender', 'looking_for', 'date_of_birth'];
    let allValid = true;
    
    fields.forEach(field => {
        const element = document.getElementById(field);
        if (!element || !element.value.trim()) {
            allValid = false;
            if (showErrors) {
                element.classList.add('validation-error');
                errors.push(`${element.labels[0].textContent} is required`);
            }
        } else {
            element.classList.remove('validation-error');
        }
    });
    
    // Additional validation for age
    const ageElement = document.getElementById('age');
    if (ageElement && ageElement.value) {
        const age = parseInt(ageElement.value);
        if (age < 18 || age > 80) {
            allValid = false;
            errors.push('Age must be between 18 and 80');
            ageElement.classList.add('validation-error');
        }
    }
    
    // Username availability check
    const usernameStatus = document.getElementById('username-status');
    if (usernameStatus && usernameStatus.classList.contains('username-taken')) {
        allValid = false;
        errors.push('Username is already taken');
    }
    
    document.getElementById('continue-to-preferences').disabled = !allValid;
    
    if (showErrors && errors.length > 0) {
        document.getElementById('basic-info-errors').textContent = errors.join(', ');
    } else {
        document.getElementById('basic-info-errors').textContent = '';
    }
    
    return allValid;
}

// STRICT Preferences Validation  
function validatePreferences(showErrors = false) {
    const errors = [];
    const requiredSelects = ['smoking', 'drinking', 'exercise', 'pets', 'diet', 'children', 'prefAgeMin', 'prefAgeMax', 'prefDistance', 'prefIntent'];
    let allValid = true;
    
    // Check dropdowns
    requiredSelects.forEach(select => {
        const element = document.querySelector(`[name="${select}"]`) || document.getElementById(select);
        if (element && !element.value) {
            allValid = false;
            if (showErrors) {
                element.classList.add('validation-error');
                errors.push(`${element.labels[0].textContent} is required`);
            }
        } else if (element) {
            element.classList.remove('validation-error');
        }
    });
    
    // Check interests (at least one)
    const interests = document.querySelectorAll('input[name="my_interests"]:checked');
    if (interests.length === 0) {
        allValid = false;
        if (showErrors) {
            document.getElementById('interests-container').style.borderColor = '#dc2626';
            errors.push('Select at least one interest');
        }
    } else {
        document.getElementById('interests-container').style.borderColor = '';
    }
    
    // Check must-have tags (at least one)
    const mustHaves = document.querySelectorAll('input[name="must_have_tags"]:checked');
    if (mustHaves.length === 0) {
        allValid = false;
        if (showErrors) {
            document.getElementById('must-have-container').style.borderColor = '#dc2626';
            errors.push('Select at least one must-have quality');
        }
    } else {
        document.getElementById('must-have-container').style.borderColor = '';
    }
    
    document.getElementById('continue-to-profile').disabled = !allValid;
    
    if (showErrors && errors.length > 0) {
        document.getElementById('preferences-errors').textContent = errors.join(', ');
    } else {
        document.getElementById('preferences-errors').textContent = '';
    }
    
    return allValid;
}

// STRICT Profile Content Validation
function validateProfileContent(showErrors = false) {
    const errors = [];
    const requiredFields = ['headline', 'location', 'about'];
    let allValid = true;
    
    // Check text fields
    requiredFields.forEach(field => {
        const element = document.querySelector(`[name="${field}"]`);
        if (!element.value.trim()) {
            allValid = false;
            if (showErrors) {
                element.classList.add('validation-error');
                errors.push(`${element.labels[0].textContent} is required`);
            }
        } else {
            element.classList.remove('validation-error');
        }
    });
    
    // Check profile photo
    if (!profilePhotoUploaded) {
        allValid = false;
        if (showErrors) {
            document.getElementById('profile-photo-container').style.borderColor = '#dc2626';
            errors.push('Profile photo is required');
        }
    } else {
        document.getElementById('profile-photo-container').style.borderColor = '';
    }
    
    document.getElementById('submit-profile').disabled = !allValid;
    
    if (showErrors && errors.length > 0) {
        document.getElementById('profile-errors').textContent = errors.join(', ');
    } else {
        document.getElementById('profile-errors').textContent = '';
    }
    
    return allValid;
}

// Username availability check
function checkUsernameAvailability(username) {
    const statusElement = document.getElementById('username-status');
    
    if (username.length < 3) {
        statusElement.textContent = 'Username must be at least 3 characters';
        statusElement.className = 'username-status username-taken';
        validateBasicInfo();
        return;
    }
    
    statusElement.textContent = 'Checking availability...';
    statusElement.className = 'username-status username-checking';
    
    fetch(`/check-username/?username=${encodeURIComponent(username)}`)
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                statusElement.textContent = '✓ Username available';
                statusElement.className = 'username-status username-available';
            } else {
                statusElement.textContent = '✗ Username already taken';
                statusElement.className = 'username-status username-taken';
            }
            validateBasicInfo();
        })
        .catch(error => {
            statusElement.textContent = 'Error checking username';
            statusElement.className = 'username-status username-taken';
            validateBasicInfo();
        });
}

// FIXED IMAGE CROPPER FUNCTIONS
function addProfilePhoto() {
    triggerFileInput('profile');
}

function addAdditionalPhoto() {
    if (uploadedPhotos.additional.length >= 4) {
        alert('Maximum 4 additional photos allowed');
        return;
    }
    triggerFileInput('additional');
}

function addPrivatePhoto() {
    if (uploadedPhotos.private.length >= 4) {
        alert('Maximum 4 private photos allowed');
        return;
    }
    triggerFileInput('private');
}

function triggerFileInput(photoType) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        if (e.target.files[0]) {
            openCropper(e.target.files[0], photoType);
        }
    };
    input.click();
}

function openCropper(file, photoType) {
    currentFile = file;
    currentPhotoType = photoType;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('imageToCrop').src = e.target.result;
        document.getElementById('cropperModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Initialize cropper
        const image = document.getElementById('imageToCrop');
        if (currentCropper) {
            currentCropper.destroy();
        }
        
        currentCropper = new Cropper(image, {
            aspectRatio: 1, // Square crop for profile photos
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 0.8,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
        });
        
        // Connect zoom slider
        document.getElementById('zoomSlider').addEventListener('input', function(e) {
            currentCropper.zoomTo(parseFloat(e.target.value));
        });
    };
    reader.readAsDataURL(file);
}

function cancelCrop() {
    document.getElementById('cropperModal').style.display = 'none';
    document.body.style.overflow = '';
    if (currentCropper) {
        currentCropper.destroy();
        currentCropper = null;
    }
}

function applyCrop() {
    if (!currentCropper) return;
    
    // Get cropped canvas
    const canvas = currentCropper.getCroppedCanvas({
        width: 400,
        height: 400,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });
    
    // Convert canvas to blob and upload
    canvas.toBlob(function(blob) {
        uploadCroppedPhoto(blob, currentPhotoType);
    }, 'image/jpeg', 0.9);
    
    // Close cropper
    cancelCrop();
}

function uploadCroppedPhoto(blob, photoType) {
    const formData = new FormData();
    formData.append('image', blob, 'cropped-photo.jpg');
    formData.append('photo_type', photoType);
    
    fetch('/upload-profile-image/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData,
    }).then(response => response.json())
      .then(data => {
        if (data.success) {
            // Store photo data with both id and url
            const photoData = {
                id: data.image_id,
                url: data.image_url
            };
            
            if (photoType === 'profile') {
                profilePhotoUploaded = true;
                uploadedPhotos.profile = photoData;
                document.getElementById('profile-photo-container').innerHTML = 
                    `<img src="${data.image_url}" alt="Profile photo" style="width:100%;height:100%;object-fit:cover">
                     <button type="button" class="btn-delete" onclick="deletePhoto('${data.image_id}', 'profile')">×</button>`;
                document.getElementById('profile_photo_id').value = data.image_id;
            } else if (photoType === 'private') {
                uploadedPhotos.private.push(photoData);
                updatePhotoGrid('private');
            } else {
                uploadedPhotos.additional.push(photoData);
                updatePhotoGrid('additional');
            }
            validateProfileContent();
        } else {
            alert('Error uploading image: ' + (data.error || 'Unknown error'));
        }
    }).catch(error => {
        alert('Error uploading image');
        console.error('Upload error:', error);
    });
}

// FIXED: Photo grid management with individual image tracking
function updatePhotoGrid(photoType) {
    const container = document.getElementById(photoType + '-photos-container');
    const countElement = document.getElementById(photoType + '-count');
    const hiddenField = document.getElementById(photoType + '_photo_ids');
    
    // Update count
    countElement.textContent = uploadedPhotos[photoType].length;
    
    // Clear container
    container.innerHTML = '';
    
    // Add existing photos with their actual URLs
    uploadedPhotos[photoType].forEach((photoData, index) => {
        container.innerHTML += `
            <div class="photo-item">
                <img src="${photoData.url}" alt="${photoType} photo ${index + 1}" 
                     style="width:100%;height:100%;object-fit:cover">
                <button type="button" class="btn-delete" onclick="deletePhoto('${photoData.id}', '${photoType}')">×</button>
            </div>
        `;
    });
    
    // Add + button if under limit
    const maxPhotos = 4;
    if (uploadedPhotos[photoType].length < maxPhotos) {
        container.innerHTML += `
            <div class="photo-item add-photo-btn" onclick="add${photoType.charAt(0).toUpperCase() + photoType.slice(1)}Photo()">
                <span>+</span>
            </div>
        `;
    }
    
    // Update hidden field with photo IDs
    const photoIds = uploadedPhotos[photoType].map(photo => photo.id).join(',');
    if (photoType === 'additional') {
        document.getElementById('additional_photo_ids').value = photoIds;
    } else if (photoType === 'private') {
        document.getElementById('private_photo_ids').value = photoIds;
    }
}

function deletePhoto(imageId, photoType) {
    if (confirm('Are you sure you want to delete this photo?')) {
        fetch(`/delete-image/${imageId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        }).then(response => {
            if (response.ok) {
                if (photoType === 'profile') {
                    profilePhotoUploaded = false;
                    uploadedPhotos.profile = null;
                    document.getElementById('profile-photo-container').innerHTML = '<span>+</span>';
                    document.getElementById('profile_photo_id').value = '';
                } else {
                    uploadedPhotos[photoType] = uploadedPhotos[photoType].filter(photo => photo.id !== imageId);
                    updatePhotoGrid(photoType);
                }
                validateProfileContent();
            }
        }).catch(error => {
            alert('Error deleting photo');
            console.error('Delete error:', error);
        });
    }
}

// Success modal functions
function showSuccessModal() {
    document.getElementById('successModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeSuccessModal() {
    document.getElementById('successModal').style.display = 'none';
    document.body.style.overflow = '';
    // Redirect to dashboard or home page after success
    window.location.href = "{% url 'dashboard' %}";
}

// Form submission with success modal
document.getElementById('profileForm').addEventListener('submit', function(e) {
    if (!validateBasicInfo(true) || !validatePreferences(true) || !validateProfileContent(true)) {
        e.preventDefault();
        alert('Please complete all required fields before submitting');
        return false;
    }
    
    // If form is valid, show success modal instead of normal submission
    e.preventDefault();
    showSuccessModal();
    
    // In a real implementation, you would submit the form via AJAX here
    // and only show success modal on successful submission
});

// Age range dropdown population
document.addEventListener('DOMContentLoaded', function() {
    const minSelect = document.getElementById('prefAgeMin');
    const maxSelect = document.getElementById('prefAgeMax');
    
    // Populate age options from 18 to 80
    if (minSelect && minSelect.options.length <= 1) {
        for (let age = 18; age <= 80; age++) {
            const option = document.createElement('option');
            option.value = age;
            option.textContent = age;
            minSelect.appendChild(option.cloneNode(true));
            maxSelect.appendChild(option);
        }
    }
    
    // Initialize validation
    validateBasicInfo();
});
</script>
{% endblock %}
